<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Babylon.js - AR Géolocalisée (Corrigé)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        #info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            background-color: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-family: sans-serif;
            font-size: 14px;
        }
    </style>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
</head>
<body>
    <div id="info">Attente des permissions...</div>
    <canvas id="renderCanvas"></canvas>

    <script>
        const canvas = document.getElementById('renderCanvas');
        const engine = new BABYLON.Engine(canvas, true);
        const infoDiv = document.getElementById('info');
        const distance = 10; // 10 mètres

        const createScene = () => {
            const scene = new BABYLON.Scene(engine);
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);

            // On utilise une caméra simple, car on va contrôler sa rotation manuellement.
            const camera = new BABYLON.FreeCamera("camera", new BABYLON.Vector3(0, 0, 0), scene);
            
            // --- PLACEMENT FIXE DES CUBES ---
            // On place les cubes à des coordonnées cardinales dans la scène. Ils ne bougeront plus.
            // En Babylon.js : +Z = Devant, +X = Droite
            
            // Cube NORD (devant)
            const cubeNorth = BABYLON.MeshBuilder.CreateBox("Nord", { size: 1 }, scene);
            cubeNorth.position = new BABYLON.Vector3(0, 0, distance);
            cubeNorth.material = new BABYLON.StandardMaterial("matN", scene);
            cubeNorth.material.emissiveColor = BABYLON.Color3.Red();

            // Cube EST (à droite)
            const cubeEast = BABYLON.MeshBuilder.CreateBox("Est", { size: 1 }, scene);
            cubeEast.position = new BABYLON.Vector3(distance, 0, 0);
            cubeEast.material = new BABYLON.StandardMaterial("matE", scene);
            cubeEast.material.emissiveColor = BABYLON.Color3.Green();

            // Cube SUD (derrière)
            const cubeSouth = BABYLON.MeshBuilder.CreateBox("Sud", { size: 1 }, scene);
            cubeSouth.position = new BABYLON.Vector3(0, 0, -distance);
            cubeSouth.material = new BABYLON.StandardMaterial("matS", scene);
            cubeSouth.material.emissiveColor = BABYLON.Color3.Blue();

            // Cube OUEST (à gauche)
            const cubeWest = BABYLON.MeshBuilder.CreateBox("Ouest", { size: 1 }, scene);
            cubeWest.position = new BABYLON.Vector3(-distance, 0, 0);
            cubeWest.material = new BABYLON.StandardMaterial("matW", scene);
            cubeWest.material.emissiveColor = BABYLON.Color3.Yellow();

            // Démarrer le fond vidéo (AR)
            setupARBackground(scene);

            // Lier la rotation de la caméra à la boussole du téléphone
            setupOrientationListener(camera);

            return scene;
        };

        const setupARBackground = (scene) => {
            // Cette fonction active la caméra de l'appareil en arrière-plan.
            // **IMPORTANT : DOIT ÊTRE SERVI VIA HTTPS**
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    const video = document.createElement('video');
                    video.setAttribute('playsinline', '');
                    video.setAttribute('autoplay', '');
                    video.srcObject = stream;
                    video.play();
                    
                    const background = new BABYLON.Layer("background", null, scene, true);
                    background.texture = new BABYLON.VideoTexture("video", video, scene, true);
                }).catch(err => {
                    infoDiv.innerHTML = "<strong>Erreur:</strong> Caméra inaccessible. Assurez-vous d'utiliser <strong>HTTPS</strong> et d'accorder la permission.";
                });
        };

        const setupOrientationListener = (camera) => {
            window.addEventListener("deviceorientationabsolute", (event) => {
                // event.alpha donne la direction de la boussole : 0 = Nord, 90 = Est, etc. (rotation horaire)
                if (event.alpha !== null) {
                    // La rotation en Babylon.js est anti-horaire. On utilise donc l'inverse de alpha.
                    const heading = -event.alpha;
                    
                    camera.rotation.y = BABYLON.Tools.ToRadians(heading);
                    infoDiv.textContent = `Cap: ${event.alpha.toFixed(1)}°`;
                }
            }, true);
        };

        // Lancement de la scène
        const scene = createScene();
        engine.runRenderLoop(() => {
            scene.render();
        });
        window.addEventListener('resize', () => {
            engine.resize();
        });

    </script>
</body>
</html>