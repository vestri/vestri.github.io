<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Babylon.js - Géolocalisation AR</title>
    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background-color: rgba(0,0,0,0.5);
            padding: 8px;
            border-radius: 5px;
            font-family: sans-serif;
        }
    </style>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
</head>
<body>
    <div id="info">En attente des données GPS et de l'orientation...</div>
    <canvas id="renderCanvas"></canvas>

    <script>
        const canvas = document.getElementById('renderCanvas');
        const engine = new BABYLON.Engine(canvas, true);
        const infoDiv = document.getElementById('info');

        // Variables pour stocker les données des capteurs
        let currentHeading = 0;
        let userLatitude = null;
        let userLongitude = null;
        const cubes = [];
        const distance = 10; // 10 mètres

        // Création de la scène
        const createScene = async () => {
            const scene = new BABYLON.Scene(engine);

            // Caméra qui suit les mouvements du gyroscope
            const camera = new BABYLON.DeviceOrientationCamera("DevOr_camera", new BABYLON.Vector3(0, 0, 0), scene);
            camera.attachControl(canvas, true);

            // Lumière
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);

            // Créer les 4 cubes
            const directions = {
                "Nord": { color: [1, 0, 0], angle: 0 },       // Rouge
                "Est":  { color: [0, 1, 0], angle: 90 },      // Vert
                "Sud":  { color: [0, 0, 1], angle: 180 },     // Bleu
                "Ouest":{ color: [1, 1, 0], angle: 270 }      // Jaune
            };

            for (const [name, props] of Object.entries(directions)) {
                const cube = BABYLON.MeshBuilder.CreateBox(name, { size: 1 }, scene);
                const material = new BABYLON.StandardMaterial(`${name}_mat`, scene);
                material.diffuseColor = new BABYLON.Color3(props.color[0], props.color[1], props.color[2]);
                material.emissiveColor = new BABYLON.Color3(props.color[0], props.color[1], props.color[2]); // Pour être bien visible
                cube.material = material;
                cubes.push({ mesh: cube, angle: props.angle });
            }

            // Mettre la caméra en fond de scène (Réalité Augmentée)
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                const video = document.createElement('video');
                video.setAttribute('playsinline', '');
                video.setAttribute('autoplay', '');
                video.setAttribute('muted', 'true');
                video.srcObject = stream;
                video.play();
                
                const background = new BABYLON.Layer("background", null, scene);
                background.texture = new BABYLON.VideoTexture("video", video, scene, true);
                background.isBackground = true;
                // Ajuste la texture pour remplir l'écran sans déformation
                const aspectRatio = video.videoWidth / video.videoHeight;
                const screenAspectRatio = engine.getRenderWidth() / engine.getRenderHeight();
                if (aspectRatio > screenAspectRatio) {
                    background.texture.uScale = screenAspectRatio / aspectRatio;
                    background.texture.uOffset = (1 - background.texture.uScale) / 2;
                } else {
                    background.texture.vScale = aspectRatio / screenAspectRatio;
                     background.texture.vOffset = (1 - background.texture.vScale) / 2;
                }

            } catch (err) {
                console.error("Erreur d'accès à la caméra: ", err);
                infoDiv.textContent = "Erreur: Impossible d'accéder à la caméra.";
            }

            return scene;
        };

        // Fonction pour mettre à jour la position des cubes
        const updateCubePositions = () => {
            if (cubes.length === 0) return;

            infoDiv.textContent = `Cap: ${currentHeading.toFixed(2)}°`;

            cubes.forEach(item => {
                // Angle du cube par rapport à la direction actuelle de l'appareil
                const angleRad = BABYLON.Tools.ToRadians(item.angle - currentHeading);

                // Calculer la position en utilisant la trigonométrie
                const x = distance * Math.sin(angleRad);
                const z = distance * Math.cos(angleRad);
                
                // On garde les cubes au niveau de la caméra (sur le plan horizontal)
                item.mesh.position.set(x, 0, z);
            });
        };

        // Démarrer la scène et les capteurs
        (async () => {
            const scene = await createScene();

            // Écouter les changements d'orientation
            window.addEventListener("deviceorientation", (event) => {
                // webkitCompassHeading est pour iOS, alpha est pour Android.
                let heading = event.webkitCompassHeading || (360 - event.alpha);
                
                if (heading !== null && heading !== undefined) {
                    currentHeading = heading;
                    updateCubePositions();
                }
            });

            // Récupérer la position GPS (optionnel ici mais nécessaire pour une vraie AR géolocalisée)
             navigator.geolocation.watchPosition(
                (position) => {
                    userLatitude = position.coords.latitude;
                    userLongitude = position.coords.longitude;
                    console.log(`Position GPS: ${userLatitude}, ${userLongitude}`);
                },
                (error) => {
                    console.error("Erreur de géolocalisation: ", error);
                    infoDiv.textContent = "Erreur: Activez le GPS.";
                },
                { enableHighAccuracy: true }
            );

            engine.runRenderLoop(() => {
                scene.render();
            });

            window.addEventListener('resize', () => {
                engine.resize();
            });
        })();
    </script>
</body>
</html>